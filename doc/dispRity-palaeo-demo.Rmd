---
title: "dispRity palaeo demo"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: References.bib
bst: sysbio.bst
vignette: >
  %\VignetteIndexEntry{dispRity palaeo demo}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

This demo aims to give quick overview of the `dispRity` package (v.0.3) for palaeobiology analysis.
Please refer to [GitHub page](https://github.com/TGuillerme/dispRity) for other vignettes, namely the [`dispRity` manual](http://htmlpreview.github.com/?https://github.com/TGuillerme/dispRity/blob/master/doc/dispRity-manual.html) that explains the functions in more detail.

To keep it short, this package allows to easily perform **disparity-through-time** analysis.
This type of analysis often starts by ordinating **morphometric** or **cladistic** data into a multidimensional object hereafter called the **morphospace**.
One might be interested in studying how the occupancy of the morphospace changed through time by measuring a summary metric of this morphospace through time, called **disparity**.
Disparity can then be seen as a value or a distribution of valuess summarising the diversity of morphologies.

This demo showcases a typical disparity-through-time analyse: we are going to test whether the disparity changed through time in a subset of Eutheria (Mammalia) since the last 100 million years.

Before starting
===============

Installing `dispRity` 
-----------------------------------

You can install this package easily if you are using the latest version of `R` and `devtools`.

```{r, eval = FALSE}
if(!require(devtools)) install.packages("devtools")
install_github("TGuillerme/dispRity", ref = "release")
library(dispRity)
```

The morphospace
---------------

In this example, we are going to use a subset of the data from [@beckancient2014] that contains an ordinated cladistic matrix and a
phylogenetic tree containing 50 taxa along side with a table containing some first and last occurences data for several taxa.
The ordinated matrix will represent our full morphospace, i.e. all the mammalian morphologies that ever existed through time (for this dataset).

```{r, fig.width=6, fig.height=6}
## Loading demo and the package data
library(dispRity)

## Setting the random seed for repeatability
set.seed(123)

## Loading the morphospace:
data(BeckLee_mat50)
head(BeckLee_mat50[,1:5])

dim(BeckLee_mat50)
## The morphospace contains 50 taxa and has 48 dimensions (or axis)

## Showing a list of first and last occurrences data for some fossils
data(BeckLee_ages)
head(BeckLee_ages)

## Plotting a phylogeny
data(BeckLee_tree)
plot(BeckLee_tree, cex=0.7); axisPhylo(root=140)
```

> You can have an even nicer looking tree if you use the `strap` package!

```{r, eval = FALSE}
if(!require(strap)) install.packages("strap")
library(strap)
geoscalePhylo(BeckLee_tree, cex.tip=0.7, cex.ts=0.6)
```

A disparity-through-time analysis
=================================

Splitting the morphospace through time
--------------------------------------

One of the crucial steps in disparity-through-time analysis is to split the full morphospace into smaller time subsamples that contain the total amount of morphologies at certain points in time (time-slicing) or during certain periods in time (time-binning).
Basically, the full morphospace in the previous step represents the total amount of morphologies in all time and is likely to be greater than any time subsamples of the morphospace.

The `dispRity` package provides a `time.subsamples` function that allows to split the morphospace time slices (using `method = continuous`) or into time bins (using `method = discrete`).
In this example, we are going to split the morphospace into 5 equal time bins of 20 million years long from 100 million years ago (Mya) to the present.
We will also provide to the function the table containing the first and last occurrences data for some fossils to take into account the fact that some fossils might span between our different time bins.

```{r}
## Creating the vector of time bins ages
(time_bins <- rev(seq(from = 0, to = 100, by = 20)))

## Splitting the morphospace using the time.subsamples function
(binned_morphospace <- time.subsamples(data = BeckLee_mat50, tree = BeckLee_tree,
    method = "discrete", time = time_bins, inc.nodes = FALSE,
    FADLAD = BeckLee_ages))
```

The output object is a `dispRity` object.
For details about this object class, please refer to the [`dispRity` manual](http://htmlpreview.github.com/?https://github.com/TGuillerme/dispRity/blob/master/doc/dispRity-manual.html).
In brief, however, `dispRity` objects are lists of different elements (i.e. disparity results, morphospace time subsamples, morphospace attributes, etc.) that display only a summary of the object when calling the object for avoiding jamming the `R` console.

```{r}
## Printing the class of the object
class(binned_morphospace)

## Printing the content of the object
str(binned_morphospace)
names(binned_morphospace)

## Printing the object as a dispRity class
binned_morphospace
```

> These objects will gradually contain more information when reaching the following steps in the disparity-through-time analysis.

Bootstrapping the data
----------------------

Once we obtain our different time subsamples, we can bootstrap and rarefy them (i.e. pseudo-replicating the data).
The bootstrapping will allow to make each subsamples more robust to outliers and the rarefaction will allow us to compare subsamples with the same number of taxa to get rid of eventual sampling problems (i.e. more taxa in one subsamples than the other).
The `boot.matrix` function that allows to bootstrap the `dispRity` object and the `rarefaction` option within allows to rarefy it.

```{r}
## Bootstrapping each time subsamples 100 times
(boot_bin_morphospace <- boot.matrix(binned_morphospace, bootstraps = 100))

## Getting the minimum number of rows (=taxa) in the time subsamples
min(unlist(lapply(boot_bin_morphospace$subsamples, lapply, nrow)))

## Bootstrapping each time subsamples 100 times and rarefying them 
(rare_bin_morphospace <- boot.matrix(binned_morphospace, bootstraps = 100,
    rarefaction = 6))
```
Calculating disparity
---------------------

We can now calculate the disparity within each time subsamples along side with some confidence intervals generated by the pseudo-replication step above (bootstraps/rarefaction).
Disparity can be calculated in many ways and this package allows user to come up with their own disparity metrics.
For more info, please refer to the [`dispRity` metric vignette](http://htmlpreview.github.com/?https://github.com/TGuillerme/dispRity/blob/master/doc/dispRity-metrics.html).

In this example, we are going to calculate the spread of the data in each time subsamples by calculating the disparity as the sum of the variance of each dimension of the morphospace in each time subsamples using the `dispRity` function.
Thus, in this example, the disparity is defined by the multi-dimensional variance of each time subsamples (i.e. the spread of the taxa within the morphospace).
Note that this metric comes with a caveat not solved here since it ignores the covariance among the dimensions of the morphospace.

```{r}
## Calculating disparity for the bootstrapped data
(boot_disparity <- dispRity(boot_bin_morphospace, metric = c(sum, variances)))

## Calculating disparity for the rarefied data
(rare_disparity <- dispRity(rare_bin_morphospace, metric = c(sum, variances)))
```

The `dispRity` function does not actually display the calculated disparity values but rather only the properties of the disparity object (size, subsamples, metric, etc.).
To display the actual calculated scores, we need to summarise the disparity object using the S3 method `summary` that is applied on a `dispRity` object (see `?summary.dispRity` for more details).

As for any `R` package, you can refer yourself to each individual function for more details.

```{r}
## Summarising the disparity results
summary(boot_disparity)
summary(rare_disparity)
```
> The summary.dispRity function comes with many options on which values to calculate (central tendency and quantiles) and on how many digits to display. Refer to the function's manual for more details.

Plotting the results
--------------------

It is sometimes easier to visualise the results in a plot than in a table.
For that we can use the `plot` S3 function to plot the `dispRity` objects (see `?plot.dispRity` for more details).

```{r, fig.width=12, fig.height=6}
## Graphical options
quartz(width = 10, height = 5) ; par(mfrow = (c(1,2)), bty = "n")

## Plotting the bootstrapped and rarefied results
plot(boot_disparity, type = "continuous", main = "bootstrapped results")
plot(rare_disparity, type = "continuous", main = "rarefied results")
```

Testing differences
-------------------

Finally, to draw some valid conclusions from these results, we can apply some statistical testing to the data.
We can test, for example, if mammalian disparity changed through time since the last 100 million years (Mya).
To do so, we can apply some comparisons of the means between each time-bins in a sequential manner to see whether the disparity in bin *n* is equal to the disparity in bin *n+1* which is in turn equal to the disparity in bin *n+2*, etc.
Because our data is temporally auto-correlated (i.e. what happens in bin *n+1* depends on what happened in bin *n*) and was pseudo-replicated (i.e. each bootstrap draw creates non-independent time subsamples because they are all based on the same time subsamples), we are going to apply a non-parametric mean comparison: the `wilcox.test`.
Also, we are going to apply a p-value correction to avoid type I error inflation due to performing multiple test for the same hypothesis (see `?p.adjust` for more details).

```{r}
## testing the differences between bins in the bootstrapped dataset.
test.dispRity(boot_disparity, test = wilcox.test, comparison = "sequential",
    correction = "bonferroni")

## testing the differences between bins in the rarefied dataset.
test.dispRity(rare_disparity, test = wilcox.test, comparison = "sequential",
    correction = "bonferroni")
```

Here our results show significant changes in disparity through time between all time bins (all p-values > 0.05).
However, when looking at the rarefied results, there is no significant difference between the time bins in the Palaeogene (60-40 to 40-20 Mya), suggesting that the differences detected in the first test might just be due to the differences in number of taxa sample (13 or 6 taxa in each time bin).

# References